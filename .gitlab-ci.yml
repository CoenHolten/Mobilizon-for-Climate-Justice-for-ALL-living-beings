image: tcitworld/mobilizon-ci

stages:
  - front
  - back

variables:
  MIX_ENV: "test"
  POSTGRES_DB: mobilizon_test
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: ""
  POSTGRES_HOST: postgres
  GEOLITE_CITIES_PATH: "/usr/share/GeoIP/GeoLite2-City.mmdb"

js:
  stage: front
  before_script:
    - cd js
    - npm install
  script:
    - npm run build
  after_script:
    - cd ../
  cache:
    paths:
      - js/node_modules
  artifacts:
    paths:
      - priv/static
    untracked: false
    expire_in: 30 days

elixir_format:
  stage: back
  before_script:
    - mix deps.get
  script:
    - mix format --check-formatted --dry-run
  cache:
    paths:
      - deps

mix:
  stage: back
  services:
  - name: mdillon/postgis:10
    alias: postgres
  dependencies:
    - js
  before_script:
    - mix deps.get
    - MIX_ENV=test mix ecto.create
    - MIX_ENV=test mix ecto.migrate
  script:
    - mix coveralls
  cache:
    paths:
      - deps
      - _build
